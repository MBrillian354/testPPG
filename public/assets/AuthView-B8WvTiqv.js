import{r,a as E,j as e,L as y,A as G,u as F,E as q,D as k,l as C}from"./index-CQE6waEO.js";import{b as A,e as T}from"./store-scanner-beep-90395-CpeJwZdq.js";const Y=({setStudentLoginField:p,setNis:w})=>{const d=r.useRef(null),m=r.useRef(null),[j,b]=r.useState(null),{isLoading:l,error:v,sendRequest:g,setError:N,setIsLoading:s}=E();r.useEffect(()=>{s(!0);let t;return(async()=>{if(d.current){t=new T(d.current,async n=>{await h(n.data)},{returnDetailedScanResult:!0});try{s(!1),await t.start()}catch(n){console.error("Camera access denied or unavailable:",n)}}else console.error("Video element not found")})(),()=>{t==null||t.destroy()}},[]);const h=async t=>{(async()=>{const n=`https://ppg-academic-system-9b62c1c7b604.herokuapp.com/api/students/login/${t}`;try{const o=await g(n);w(o.student.nis),b(o.student),console.log(o.student),p([{name:"nis",label:"nis",type:"text",required:!1,value:o.student.nis,disabled:!0},{name:"name",label:"name",type:"text",required:!1,value:o.student.name,disabled:!0},{name:"password",label:"Password",placeholder:"Password",type:"password",required:!0}])}catch{}})(),m.current&&m.current.play()};return e.jsxs("div",{className:"flex flex-col items-center justify-center h-full w-full p-4",children:[e.jsxs("div",{className:"relative w-72 h-72 border-2 border-gray-700 shadow-md rounded-md overflow-hidden",children:[l===!0?e.jsx("div",{className:" absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2",children:e.jsx(y,{size:32})}):e.jsx("video",{ref:d,className:"absolute inset-0 w-full h-full object-cover",playsInline:!0}),e.jsxs("div",{className:"absolute inset-[8.25%] w-5/6 h-5/6 pointer-events-none",children:[e.jsx("div",{className:"absolute top-0 left-0 w-12 h-12 border-t-4 border-l-4 border-white"}),e.jsx("div",{className:"absolute top-0 right-0 w-12 h-12 border-t-4 border-r-4 border-white"}),e.jsx("div",{className:"absolute bottom-0 left-0 w-12 h-12 border-b-4 border-l-4 border-white"}),e.jsx("div",{className:"absolute bottom-0 right-0 w-12 h-12 border-b-4 border-r-4 border-white"})]})]}),e.jsx("audio",{ref:m,src:A,preload:"auto"})]})},U=()=>{const[p,w]=r.useState(!1),[d,m]=r.useState(!1),[j,b]=r.useState(!1),[l,v]=r.useState([]),[g,N]=r.useState(),{isLoading:s,error:h,sendRequest:t,setError:f}=E(),n=r.useContext(G),o=F();r.useEffect(()=>{b([{name:"email",label:"Email",placeholder:"Email",type:"email",required:!0},{name:"password",label:"Password",placeholder:"Password",type:"password",required:!0}])},[l]);const S=async I=>{var P,L;const R="https://ppg-academic-system-9b62c1c7b604.herokuapp.com/api/users/login",$=JSON.stringify({email:I.email,password:I.password,nis:g});let a,x;try{a=await t(R,"POST",$,{"Content-Type":"application/json"});try{x=await t(`https://ppg-academic-system-9b62c1c7b604.herokuapp.com/api/teachingGroupYears/teachingGroup/${a.user.teachingGroupId.id}`)}catch{}let i;x&&(i=x.teachingGroupYears.find(c=>c.academicYearId.isActive));let u;if(a.user.role==="teacher")try{u=await t(`https://ppg-academic-system-9b62c1c7b604.herokuapp.com/api/teachers/user/${a.user.id}`),console.log(u)}catch(c){console.log(c)}console.log("logging IN"),console.log(a);const D=((P=u==null?void 0:u.teacher)==null?void 0:P.classIds.map(c=>c._id))||[];n.login(a.user.id,a.user.role,a.user.name,a.user.teachingGroupId.branchId.id,a.user.teachingGroupId.id,((L=i==null?void 0:i.academicYearId)==null?void 0:L.name)||null,D,a.token),console.log("logged IN")}catch(i){console.log(i)}};return e.jsx("div",{className:"m-auto max-w-md mt-16 md:mt-24",children:e.jsxs("div",{className:`pb-24 transition-opacity duration-300 ${d?"opacity-0":"opacity-100"}`,children:[h&&e.jsx("div",{className:"px-2",children:e.jsx(q,{error:h,onClear:()=>f(null)})}),p===!1&&e.jsx(k,{logo:C,title:"PPG Cikampek",subtitle:"Sistem Absensi Digital",fields:j,onSubmit:S,disabled:s,labels:!1,button:e.jsx("div",{className:"flex flex-col justify-stretch mt-4",children:e.jsx("button",{type:"submit",className:`button-primary ${s?"opacity-50 cursor-not-allowed":""}`,disabled:s,children:s?e.jsx(y,{children:"Processing..."}):"Login"})}),helpButton:e.jsx("div",{onClick:()=>o("/reset-password/reset"),className:"text-center mt-2",children:e.jsx("p",{className:"underline text-xs text-gray-600 active:text-primary hover:text-primary hover:cursor-pointer",children:"Reset Password"})})}),p===!0&&e.jsx(k,{logo:C,title:"PPG Cikampek",subtitle:"Sistem Absensi Digital",onSubmit:S,disabled:s,fields:l,labels:!1,button:e.jsx("div",{className:"flex flex-col justify-stretch mt-4",children:l.length!==0&&e.jsx("button",{type:"submit",className:`button-primary ${s?"opacity-50 cursor-not-allowed":""}`,disabled:s,children:s?e.jsx(y,{children:"Processing..."}):"Login"})}),helpButton:l.length===0&&e.jsx(Y,{setStudentLoginField:v,setNis:N})})]})})};export{U as default};
