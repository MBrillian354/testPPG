import{r,b as R,j as e,L as y,A as F,u as k,E as q,D as C}from"./index-Baf2cdGO.js";import{l as E}from"./ppgcikampek-CM1E7Efd.js";import{b as A,e as T}from"./store-scanner-beep-90395-Ca-smzKY.js";const Y=({setStudentLoginField:m,setNis:w})=>{const c=r.useRef(null),p=r.useRef(null),[j,b]=r.useState(null),{isLoading:l,error:v,sendRequest:f,setError:N,setIsLoading:s}=R();r.useEffect(()=>{s(!0);let t;return(async()=>{if(c.current){t=new T(c.current,async n=>{await h(n.data)},{returnDetailedScanResult:!0});try{s(!1),await t.start()}catch(n){console.error("Camera access denied or unavailable:",n)}}else console.error("Video element not found")})(),()=>{t==null||t.destroy()}},[]);const h=async t=>{(async()=>{const n=`http://103.127.133.63:5000/api/students/login/${t}`;try{const o=await f(n);w(o.student.nis),b(o.student),console.log(o.student),m([{name:"nis",label:"nis",type:"text",required:!1,value:o.student.nis,disabled:!0},{name:"name",label:"name",type:"text",required:!1,value:o.student.name,disabled:!0},{name:"password",label:"Password",placeholder:"Password",type:"password",required:!0}])}catch{}})(),p.current&&p.current.play()};return e.jsxs("div",{className:"flex flex-col items-center justify-center h-full w-full p-4",children:[e.jsxs("div",{className:"relative w-72 h-72 border-2 border-gray-700 shadow-md rounded-md overflow-hidden",children:[l===!0?e.jsx("div",{className:" absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2",children:e.jsx(y,{size:32})}):e.jsx("video",{ref:c,className:"absolute inset-0 w-full h-full object-cover",playsInline:!0}),e.jsxs("div",{className:"absolute inset-[8.25%] w-5/6 h-5/6 pointer-events-none",children:[e.jsx("div",{className:"absolute top-0 left-0 w-12 h-12 border-t-4 border-l-4 border-white"}),e.jsx("div",{className:"absolute top-0 right-0 w-12 h-12 border-t-4 border-r-4 border-white"}),e.jsx("div",{className:"absolute bottom-0 left-0 w-12 h-12 border-b-4 border-l-4 border-white"}),e.jsx("div",{className:"absolute bottom-0 right-0 w-12 h-12 border-b-4 border-r-4 border-white"})]})]}),e.jsx("audio",{ref:p,src:A,preload:"auto"})]})},V=()=>{const[m,w]=r.useState(!1),[c,p]=r.useState(!1),[j,b]=r.useState(!1),[l,v]=r.useState([]),[f,N]=r.useState(),{isLoading:s,error:h,sendRequest:t,setError:g}=R(),n=r.useContext(F),o=k();r.useEffect(()=>{b([{name:"email",label:"Email",placeholder:"Email",type:"email",required:!0},{name:"password",label:"Password",placeholder:"Password",type:"password",required:!0}])},[l]);const S=async I=>{var P,L;const $="http://103.127.133.63:5000/api/users/login",D=JSON.stringify({email:I.email,password:I.password,nis:f});let a,x;try{a=await t($,"POST",D,{"Content-Type":"application/json"});try{x=await t(`http://103.127.133.63:5000/api/teachingGroupYears/teachingGroup/${a.user.teachingGroupId.id}`)}catch{}let i;x&&(i=x.teachingGroupYears.find(d=>d.academicYearId.isActive));let u;if(a.user.role==="teacher")try{u=await t(`http://103.127.133.63:5000/api/teachers/user/${a.user.id}`),console.log(u)}catch(d){console.log(d)}console.log("logging IN"),console.log(a);const G=((P=u==null?void 0:u.teacher)==null?void 0:P.classIds.map(d=>d._id))||[];n.login(a.user.id,a.user.role,a.user.name,a.user.teachingGroupId.branchId.id,a.user.teachingGroupId.id,((L=i==null?void 0:i.academicYearId)==null?void 0:L.name)||null,G,a.token),console.log("logged IN")}catch(i){console.log(i)}};return e.jsx("div",{className:"m-auto max-w-md mt-16 md:mt-24",children:e.jsxs("div",{className:`pb-24 transition-opacity duration-300 ${c?"opacity-0":"opacity-100"}`,children:[h&&e.jsx("div",{className:"px-2",children:e.jsx(q,{error:h,onClear:()=>g(null)})}),m===!1&&e.jsx(C,{logo:E,title:"PPG Cikampek",subtitle:"Sistem Absensi Digital",fields:j,onSubmit:S,disabled:s,labels:!1,button:e.jsx("div",{className:"flex flex-col justify-stretch mt-4",children:e.jsx("button",{type:"submit",className:`button-primary ${s?"opacity-50 cursor-not-allowed":""}`,disabled:s,children:s?e.jsx(y,{children:"Processing..."}):"Login"})}),helpButton:e.jsx("div",{onClick:()=>o("/reset-password/reset"),className:"text-center mt-2",children:e.jsx("p",{className:"underline text-xs text-gray-600 active:text-primary hover:text-primary hover:cursor-pointer",children:"Reset Password"})})}),m===!0&&e.jsx(C,{logo:E,title:"PPG Cikampek",subtitle:"Sistem Absensi Digital",onSubmit:S,disabled:s,fields:l,labels:!1,button:e.jsx("div",{className:"flex flex-col justify-stretch mt-4",children:l.length!==0&&e.jsx("button",{type:"submit",className:`button-primary ${s?"opacity-50 cursor-not-allowed":""}`,disabled:s,children:s?e.jsx(y,{children:"Processing..."}):"Login"})}),helpButton:l.length===0&&e.jsx(Y,{setStudentLoginField:v,setNis:N})})]})})};export{V as default};
