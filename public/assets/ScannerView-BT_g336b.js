import{c as T,r as i,F as w,j as e,a as L,d as A,u as D,A as E,e as z,L as H}from"./index-CQE6waEO.js";import{b as F,e as G}from"./store-scanner-beep-90395-CpeJwZdq.js";import{S}from"./SequentialAnimation--7ZBrHTC.js";import{I as C}from"./iconify-Ba938JRF.js";import{C as R}from"./chevron-up-DWPvNNTb.js";import{C as K}from"./chevron-down-Bm9guId9.js";import{I as P}from"./InfoCard-BBAole_9.js";/**
 * @license lucide-react v0.454.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const _=T("LoaderCircle",[["path",{d:"M21 12a9 9 0 1 1-6.219-8.56",key:"13zald"}]]);/**
 * @license lucide-react v0.454.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const y=T("SquareCheck",[["rect",{width:"18",height:"18",x:"3",y:"3",rx:"2",key:"afitv7"}],["path",{d:"m9 12 2 2 4-4",key:"dzmm74"}]]),M=()=>{const a=i.useRef(null),l=i.useRef(null),[x,d]=i.useState(!1),[c,n]=i.useState(null),[u,b]=i.useState(!1),{state:h,dispatch:v}=i.useContext(w),[g,m]=i.useState(0);i.useEffect(()=>{let s;return(async()=>{if(a.current){s=new G(a.current,async r=>{u||await t(r.data)},{returnDetailedScanResult:!0});try{await s.start(),d(!0)}catch(r){console.error("Camera access denied or unavailable:",r)}}else console.error("Video element not found")})(),()=>{s==null||s.destroy(),d(!1)}},[u]),i.useEffect(()=>{m(u?100:0)},[u]);const j=s=>{const o=new Date,r=o.getHours(),k=o.getMinutes(),[N,I]=s.split(":").map(Number);return r>N||r===N&&k>I?"Terlambat":(r<N||r===N&&k<I,"Hadir")},p=s=>{v({type:"SET_STATUS",payload:s})};let f;const t=async s=>{b(!0);const o=h.studentList.some(r=>r.studentId.nis===s);n(o?{nis:s,status:j(h.classStartTime),name:h.studentList.find(r=>r.studentId.nis===s).studentId.name}:"Kode QR tidak dikenali!"),l.current&&l.current.play(),f={id:s,newStatus:j(h.classStartTime),timestamp:Date.now()},p(f),console.log(f),l.current&&await new Promise(r=>{l.current.onended=r}),setTimeout(()=>{b(!1)},500)};return e.jsxs("div",{className:"flex flex-col items-center justify-center h-full w-full p-4",children:[e.jsxs("div",{className:"relative w-72 h-72 border-2 border-gray-700 shadow-md rounded-md overflow-hidden",children:[u===!0?e.jsx("div",{className:" absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2",children:e.jsx(S,{variant:typeof c=="string"?6:2,children:c&&e.jsx("div",{className:"flex-col text-center",children:typeof c=="string"?e.jsx("p",{className:"text-red-500 font-semibold text-base",children:c}):e.jsxs(e.Fragment,{children:[e.jsx("p",{className:"text-gray-700 text-lg",children:c.name}),e.jsx("p",{className:"text-gray-700 text-lg",children:c.nis}),e.jsx("p",{className:"text-green-500 font-bold text-2xl",children:c.status})]})})})}):e.jsx("video",{ref:a,className:"absolute inset-0 w-full h-full object-cover",playsInline:!0}),e.jsxs("div",{className:"absolute inset-[8.25%] w-5/6 h-5/6 pointer-events-none",children:[e.jsx("div",{className:"absolute top-0 left-0 w-12 h-12 border-t-4 border-l-4 border-white"}),e.jsx("div",{className:"absolute top-0 right-0 w-12 h-12 border-t-4 border-r-4 border-white"}),e.jsx("div",{className:"absolute bottom-0 left-0 w-12 h-12 border-b-4 border-l-4 border-white"}),e.jsx("div",{className:"absolute bottom-0 right-0 w-12 h-12 border-b-4 border-r-4 border-white"})]})]}),e.jsx("audio",{ref:l,src:F,preload:"auto"})]})},O=()=>{const[a,l]=i.useState(new Date);i.useEffect(()=>{const n=setInterval(()=>{l(new Date)},1e3);return()=>{clearInterval(n)}},[]);const x=n=>n.toLocaleDateString("id-ID",{day:"2-digit",timeZone:"Asia/Jakarta"}),d=n=>n.toLocaleDateString("id-ID",{month:"long",year:"numeric",timeZone:"Asia/Jakarta"}),c=n=>n.toLocaleTimeString("id-ID",{hour12:!1,hour:"2-digit",minute:"2-digit",second:"2-digit",timeZone:"Asia/Jakarta"});return e.jsxs("div",{className:"flex items-center",children:[e.jsx("span",{className:"font-semibold text-2xl mr-3",children:x(a)}),e.jsxs("span",{className:"mr-2",children:[d(a),","]}),e.jsxs("span",{className:"",children:[c(a)," WIB"]})]})},Y=()=>{const{state:a,dispatch:l}=i.useContext(w);return e.jsxs("div",{className:"border-2 border-primary rounded-full p-2 text-medium text-primary",children:[a.studentList.filter(x=>x.status==="Hadir").length,"/",a.studentList.length]})},$=()=>e.jsxs("div",{className:"card-basic mx-0 rounded-2xl mb-0 justify-between items-center",children:[e.jsx(O,{}),e.jsx(Y,{})]}),B=()=>{const{state:a,dispatch:l}=i.useContext(w),x=i.useRef(a.studentList),{isLoading:d,error:c,sendRequest:n}=L(),[u,b]=i.useState(!1);i.useState({attitude:!1,attribute:!1,behavior:!1});const h=async t=>{try{const s="https://ppg-academic-system-9b62c1c7b604.herokuapp.com/api/attendances/",o=JSON.stringify({updates:t});console.log(o);const r=await n(s,"PATCH",o,{"Content-Type":"application/json"});console.log("Successfully updated statuses:",r)}catch(s){console.error("Error updating statuses:",s)}};i.useEffect(()=>{const t=[];a.studentList.forEach((s,o)=>{const r=x.current[o];r&&(r.status!==s.status||r.attributes!==s.attributes||r.violations!==s.violations||r.notes!==s.notes)&&t.push({attendanceId:s._id,status:s.status,attributes:s.attributes,violations:s.violations,notes:s.notes,timestamp:s.timestamp})}),t.length>0&&h(t),x.current=a.studentList},[a.studentList]);const v=(t,s,o=Date.now())=>{l({type:"SET_STATUS",payload:{id:t,newStatus:s,timestamp:o}})},g=(t,s)=>{l({type:"SET_VIOLATIONS",payload:{id:t,violationType:s}})},m=t=>{l({type:"TOGGLE_SELECTED",payload:{id:t}})},j=()=>{l({type:"TOGGLE_SELECT_ALL"})},p=(t,s=Date.now())=>{l({type:"APPLY_BULK_STATUS",payload:{newStatus:t,timestamp:s}})},f=t=>{switch(t){case"Hadir":return"bg-blue-500/50";case"Terlambat":return"bg-yellow-500/50";case"Sakit":return"bg-violet-500/50";case"Izin":return"bg-orange-500/50";default:return"bg-red-500/50"}};return e.jsxs("div",{className:"p-4 space-y-4 bg-white rounded-2xl",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("h1",{className:"text-lg font-medium",children:"Daftar Hadir"}),a.studentList.length!==0&&(d?e.jsxs("div",{className:"flex items-center gap-2 animate-pulse",children:[e.jsx(_,{size:24,className:"animate-spin"}),e.jsx("span",{className:"text-xs text-gray-600",children:"Menyimpan otomatis..."})]}):c?e.jsx(C,{icon:"mdi:cloud-alert-outline",width:"24",height:"24"}):e.jsxs("div",{className:"flex items-center gap-2 animate-pulse",children:[e.jsx(C,{icon:"ci:cloud-check",width:"24",height:"24"}),e.jsx("span",{className:"text-xs text-gray-600",children:"Perubahan tersimpan"})]}))]}),a.studentList.length!==0&&a.isTeachingGroupYearActivated===!0?e.jsxs("div",{className:"inline-flex items-center",children:[e.jsxs("label",{className:"flex items-center cursor-pointer relative",htmlFor:"check-2",children:[e.jsx("input",{type:"checkbox",checked:a.selectAll,onChange:j,className:"peer h-4 w-4 cursor-pointer transition-all appearance-none rounded shadow hover:shadow-md border border-slate-300 checked:bg-primary checked:border-primary",id:"check-2"}),e.jsx("span",{className:"absolute text-white opacity-0 peer-checked:opacity-100 top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2",children:e.jsx(y,{})})]}),e.jsx("label",{className:"cursor-pointer ml-2 text-sm",htmlFor:"check-2",children:"Pilih Semua"})]}):e.jsx("div",{className:"italic text-gray-500 mt-2",children:"Daftar hadir kosong"}),e.jsx("div",{className:"flex flex-col",children:a.isTeachingGroupYearActivated===!0&&a.studentList.map(t=>e.jsxs("div",{className:`p-4 pr-0 mx-[-1rem] min-h-20 flex items-center gap-4 border-b ${f(t.status)} transition-all duration-500`,children:[e.jsxs("label",{className:"flex items-center cursor-pointer relative",htmlFor:t.studentId.nis,children:[e.jsx("input",{type:"checkbox",checked:!!t.isSelected,onChange:()=>m(t.studentId.nis),className:"peer h-4 w-4 cursor-pointer transition-all appearance-none rounded shadow hover:shadow-md border border-slate-300 checked:bg-primary checked:border-primary",id:t.studentId.nis,disabled:t.status==="Hadir"||t.status==="Terlambat"}),e.jsx("span",{className:"absolute text-white opacity-0 peer-checked:opacity-100 top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2",children:e.jsx(y,{})})]}),e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex gap-2 items-center mb-2",children:[t.studentId.image?e.jsx("img",{src:`https://ppg-academic-system-9b62c1c7b604.herokuapp.com/api/${t.studentId.image}`,alt:"Profile",className:"rounded-full size-10 shrink-0"}):e.jsx(A,{studentName:t.studentId.name,clsName:"size-10 rounded-full bg-blue-200 text-blue-500 flex items-center justify-center font-medium"}),e.jsxs("div",{className:"flex flex-col",children:[e.jsx("div",{className:"uppercase",children:t.studentId.name}),e.jsx("div",{className:"text-xs text-gray-800",children:t.studentId.nis})]})]}),e.jsxs("div",{className:"flex flex-wrap gap-2",children:[e.jsxs("select",{value:t.status||"",onChange:s=>v(t.studentId.nis,s.target.value),className:"border p-1 rounded-full active:ring-2 active:ring-blue-300 h-min",disabled:t.status==="Hadir"||t.status==="Terlambat",children:[e.jsx("option",{value:null,children:"Tanpa Keterangan"}),e.jsx("option",{value:"Hadir",disabled:!0,children:"Hadir"}),e.jsx("option",{value:"Terlambat",disabled:!0,children:"Terlambat"}),e.jsx("option",{value:"Sakit",children:"Sakit"}),e.jsx("option",{value:"Izin",children:"Izin"})]}),e.jsxs("div",{className:"relative w-full",children:[e.jsxs("button",{type:"button",className:`border p-1 px-2 rounded-full active:ring-2 active:ring-blue-300 bg-white flex justify-between items-center ${(t.status==="Sakit"||t.status==="Izin"||t.status==="Tanpa Keterangan")&&"hidden"}`,onClick:()=>b(s=>!s),children:["Temuan",u?e.jsx(R,{size:16}):e.jsx(K,{size:16})]}),u&&e.jsx("div",{className:"mt-2 mr-4 rounded-md bg-white ring-1 ring-black ring-opacity-5",children:e.jsxs("div",{className:"flex flex-col",children:[e.jsxs("div",{className:"px-4 inline-flex items-center",children:[e.jsxs("label",{className:"flex items-center cursor-pointer p-2 relative",htmlFor:t.studentId.nis+"attribute",children:[e.jsx("input",{type:"checkbox",checked:!!t.violations.attribute,onChange:()=>g(t.studentId.nis,"Attribute"),className:"peer h-4 w-4 cursor-pointer transition-all appearance-none rounded shadow hover:shadow-md border border-slate-300 checked:bg-primary checked:border-primary",id:t.studentId.nis+"attribute",disabled:t.status==="Sakit"||t.status==="Izin"||t.status==="Tanpa Keterangan"}),e.jsx("span",{className:"absolute text-white opacity-0 peer-checked:opacity-100 top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2",children:e.jsx(y,{})})]}),e.jsx("label",{className:"cursor-pointer text-sm",htmlFor:t.studentId.nis+"attribute",children:"Atribut"})]}),e.jsxs("div",{className:"px-4 inline-flex items-center",children:[e.jsxs("label",{className:"flex items-center cursor-pointer p-2 relative",htmlFor:t.studentId.nis+"attitude",children:[e.jsx("input",{type:"checkbox",checked:!!t.violations.attitude,onChange:()=>g(t.studentId.nis,"Attitude"),className:"peer h-4 w-4 cursor-pointer transition-all appearance-none rounded shadow hover:shadow-md border border-slate-300 checked:bg-primary checked:border-primary",id:t.studentId.nis+"attitude",disabled:t.status==="Sakit"||t.status==="Izin"||t.status==="Tanpa Keterangan"}),e.jsx("span",{className:"absolute text-white opacity-0 peer-checked:opacity-100 top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2",children:e.jsx(y,{})})]}),e.jsx("label",{className:"cursor-pointer text-sm",htmlFor:t.studentId.nis+"attitude",children:"Sikap"})]}),e.jsxs("div",{className:"px-4 inline-flex items-center",children:[e.jsxs("label",{className:"flex items-center cursor-pointer p-2 relative",htmlFor:t.studentId.nis+"tidiness",children:[e.jsx("input",{type:"checkbox",checked:!!t.violations.tidiness,onChange:()=>g(t.studentId.nis,"tidiness"),className:"peer h-4 w-4 cursor-pointer transition-all appearance-none rounded shadow hover:shadow-md border border-slate-300 checked:bg-primary checked:border-primary",id:t.studentId.nis+"tidiness",disabled:t.status==="Sakit"||t.status==="Izin"||t.status==="Tanpa Keterangan"}),e.jsx("span",{className:"absolute text-white opacity-0 peer-checked:opacity-100 top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2",children:e.jsx(y,{})})]}),e.jsx("label",{className:"cursor-pointer text-sm",htmlFor:t.studentId.nis+"tidiness",children:"Kerapihan"})]})]})})]})]})]})]},t.studentId.nis))}),a.isTeachingGroupYearActivated===!0&&a.studentList.length!==0&&e.jsx("div",{className:"flex justify-between items-center",children:e.jsxs("div",{className:"flex gap-2",children:[e.jsx("button",{onClick:()=>p("Sakit"),className:"btn-mobile-secondary-outline",disabled:a.studentList.filter(t=>t.isSelected===!0).length===0,children:"Sakit"}),e.jsx("button",{onClick:()=>p("Izin"),className:"btn-mobile-danger-outline",disabled:a.studentList.filter(t=>t.isSelected===!0).length===0,children:"Izin"})]})})]})},X=()=>{const{error:a,sendRequest:l,setError:x}=L(),[d,c]=i.useState(!0),{state:n,dispatch:u,fetchAttendanceData:b}=i.useContext(w),h=D(),g=i.useContext(E).userClassIds,m=z().classId;i.useEffect(()=>{c(!0);let p;m?(p=new Date().toLocaleDateString("en-CA"),b(m,p,u)):h("/scan/select-class"),c(!1)},[g,m]);const j=async()=>{if(c(!0),n.studentList.length===0){const p="https://ppg-academic-system-9b62c1c7b604.herokuapp.com/api/attendances/create-new-attendances",f=JSON.stringify({classId:m});try{await l(p,"POST",f,{"Content-Type":"application/json"});const t=new Date().toLocaleDateString("en-CA");await b(m,t,u),h(`/scan/class/${m}`,{replace:!0})}catch(t){console.error(t)}}c(!1)};return console.log(n),e.jsxs("div",{className:"flex flex-col pb-24",children:[e.jsx(S,{variant:2,children:e.jsx($,{})}),d&&e.jsx("div",{className:"flex justify-center mt-16 ",children:e.jsx(H,{size:32})}),!d&&e.jsxs(S,{variant:2,children:[n.studentList.length===0&&!d&&e.jsxs("div",{className:"card-basic m-4 justify-between items-center flex flex-col gap-2",children:[e.jsx("button",{onClick:()=>j(),className:"btn-mobile-primary rounded-full w-full",disabled:n.isTeachingGroupYearActivated===!1,children:"Buat daftar hadir hari ini"}),n.isTeachingGroupYearActivated===!1?e.jsx("span",{className:"text-danger",children:"Tahun ajaran belum aktif, hubungi Kelompok!"}):""]}),n.studentList.length!==0&&!d&&e.jsxs(e.Fragment,{children:[n.isTeachingGroupYearActivated===!0&&e.jsx("div",{className:"card-basic m-4",children:e.jsx(M,{})}),n.isTeachingGroupYearActivated===!1?e.jsx(P,{className:"mx-4 my-12",children:e.jsx("p",{children:"Tahun ajaran belum aktif, hubungi Kelompok!"})}):""]}),e.jsx(B,{})]})]})};export{X as default};
