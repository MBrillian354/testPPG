import{r as s,a as $,j as e,A as F,u as q,E as T,D as R,L as I}from"./index-KLsTS_8o.js";import{l as L}from"./ppgcikampek-CM1E7Efd.js";import{b as A,e as Y}from"./store-scanner-beep-90395-DaLQZKBq.js";const O=({setStudentLoginField:c,setNis:j})=>{const b=s.useRef(null),d=s.useRef(null),[k,f]=s.useState(!1);s.useState(null);const[a,w]=s.useState(null),[l,C]=s.useState(!1),[t,h]=s.useState(0),{isLoading:g,error:v,sendRequest:N,setError:E}=$();s.useEffect(()=>{let r;return(async()=>{if(b.current){r=new Y(b.current,async i=>{l||await y(i.data)},{returnDetailedScanResult:!0});try{await r.start(),f(!0)}catch(i){console.error("Camera access denied or unavailable:",i)}}else console.error("Video element not found")})(),()=>{r==null||r.destroy(),f(!1)}},[l]),s.useEffect(()=>{h(l?100:0)},[l]);const y=async r=>{(async()=>{const i=`https://ppg-academic-system-9b62c1c7b604.herokuapp.com/api/students/login/${r}`;try{const o=await N(i);j(o.student.nis),w(o.student),console.log(o.student),c([{name:"nis",label:"nis",type:"text",required:!1,value:o.student.nis,disabled:!0},{name:"name",label:"name",type:"text",required:!1,value:o.student.name,disabled:!0},{name:"password",label:"Password",placeholder:"Password",type:"password",required:!0}])}catch{}})(),d.current&&d.current.play()};return e.jsxs("div",{className:"flex flex-col items-center justify-center h-full w-full p-4",children:[e.jsxs("div",{className:"relative w-72 h-72 border-2 border-gray-700 shadow-md rounded-md overflow-hidden",children:[l===!0?e.jsx("div",{className:" absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2",children:a&&e.jsx("div",{className:"flex-col text-center",children:typeof a=="string"?e.jsx("p",{className:"text-red-500 font-semibold text-base",children:a}):e.jsxs(e.Fragment,{children:[e.jsx("p",{className:"text-gray-700 text-lg",children:a.name}),e.jsx("p",{className:"text-gray-700 text-lg",children:a.nis})]})})}):e.jsx("video",{ref:b,className:"absolute inset-0 w-full h-full object-cover",playsInline:!0}),e.jsxs("div",{className:"absolute inset-[8.25%] w-5/6 h-5/6 pointer-events-none",children:[e.jsx("div",{className:"absolute top-0 left-0 w-12 h-12 border-t-4 border-l-4 border-white"}),e.jsx("div",{className:"absolute top-0 right-0 w-12 h-12 border-t-4 border-r-4 border-white"}),e.jsx("div",{className:"absolute bottom-0 left-0 w-12 h-12 border-b-4 border-l-4 border-white"}),e.jsx("div",{className:"absolute bottom-0 right-0 w-12 h-12 border-b-4 border-r-4 border-white"})]})]}),e.jsx("audio",{ref:d,src:A,preload:"auto"})]})},U=()=>{const[c,j]=s.useState(!1),[b,d]=s.useState(!1),[k,f]=s.useState(!1),[a,w]=s.useState([]),[l,C]=s.useState(),{isLoading:t,error:h,sendRequest:g,setError:v}=$(),N=s.useContext(F),E=q();s.useEffect(()=>{f([{name:"email",label:"Email",placeholder:"Email",type:"email",required:!0},{name:"password",label:"Password",placeholder:"Password",type:"password",required:!0}])},[a]);const y=async u=>{var G,P;const i="https://ppg-academic-system-9b62c1c7b604.herokuapp.com/api/users/login",o=JSON.stringify({email:u.email,password:u.password,nis:l});let n,S;try{n=await g(i,"POST",o,{"Content-Type":"application/json"});try{S=await g(`https://ppg-academic-system-9b62c1c7b604.herokuapp.com/api/teachingGroupYears/teachingGroup/${n.user.teachingGroupId.id}`)}catch{}let m;S&&(m=S.teachingGroupYears.find(p=>p.academicYearId.isActive));let x;if(n.user.role==="teacher")try{x=await g(`https://ppg-academic-system-9b62c1c7b604.herokuapp.com/api/teachers/user/${n.user.id}`),console.log(x)}catch(p){console.log(p)}console.log("logging IN"),console.log(n);const D=((G=x==null?void 0:x.teacher)==null?void 0:G.classIds.map(p=>p._id))||[];N.login(n.user.id,n.user.role,n.user.name,n.user.teachingGroupId.id,((P=m==null?void 0:m.academicYearId)==null?void 0:P.name)||null,D,n.token),console.log("logged IN")}catch(m){console.log(m)}},r=()=>{d(!0),v(null),setTimeout(()=>{j(u=>!u),d(!1)},200)};return e.jsx("div",{className:"m-auto max-w-md mt-16 md:mt-24",children:e.jsxs("div",{className:`pb-24 transition-opacity duration-300 ${b?"opacity-0":"opacity-100"}`,children:[h&&e.jsx("div",{className:"px-2",children:e.jsx(T,{error:h,onClear:()=>v(null)})}),c===!1&&e.jsx(R,{logo:L,title:"PPG Cikampek",subtitle:"Sistem Absensi Digital",fields:k,onSubmit:y,disabled:t,labels:!1,button:e.jsxs("div",{className:"flex flex-col justify-stretch mt-4",children:[e.jsx("button",{type:"submit",className:`button-primary ${t?"opacity-50 cursor-not-allowed":""}`,disabled:t,children:t?e.jsx(I,{children:"Processing..."}):"Login"}),e.jsx("button",{type:"button",onClick:r,className:"button-secondary",disabled:t,children:c?"Gunakan Email":"Gunakan Kode QR"})]}),helpButton:e.jsx("div",{onClick:()=>E("/reset-password/reset"),className:"text-center mt-2",children:e.jsx("p",{className:"underline text-xs text-gray-600 active:text-primary hover:text-primary hover:cursor-pointer",children:"Reset Password"})})}),c===!0&&e.jsx(R,{logo:L,title:"PPG Cikampek",subtitle:"Sistem Absensi Digital",onSubmit:y,disabled:t,fields:a,labels:!1,button:e.jsxs("div",{className:"flex flex-col justify-stretch mt-4",children:[a.length!==0&&e.jsx("button",{type:"submit",className:`button-primary ${t?"opacity-50 cursor-not-allowed":""}`,disabled:t,children:t?e.jsx(I,{children:"Processing..."}):"Login"}),e.jsx("button",{type:"button",onClick:r,className:"button-secondary",disabled:t,children:c?"Gunakan Email":"Gunakan Kode QR"})]}),helpButton:a.length===0&&e.jsx(O,{setStudentLoginField:w,setNis:C})})]})})};export{U as default};
